<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#FFB800">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="CalPro">
  <meta name="mobile-web-app-capable" content="yes">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>CalPro - Calibration Management System</title>
  
  <!-- Modular CSS -->
  <link rel="stylesheet" href="css/main.css?v=20251017">
  <link rel="manifest" href="manifest.json">
  
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
  
  <!-- Heavy Libraries - Load on Demand -->
  <script>
    window.loadJsPDF = function() {
      if (!window.jsPDFLoading && !window.jsPDF) {
        window.jsPDFLoading = true;
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = () => window.jsPDFLoading = false;
        document.head.appendChild(script);
      }
    };
    
    window.loadChartJS = function() {
      if (!window.chartJSLoading && !window.Chart) {
        window.chartJSLoading = true;
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
        script.onload = () => window.chartJSLoading = false;
        document.head.appendChild(script);
      }
    };
  </script>
  
  <!-- Loading Screen Styles -->
  <style>
    #appLoadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease-out;
    }
    #appLoadingScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    @media (max-width: 768px) {
      .loading-logo { width: 80px !important; height: 80px !important; margin-bottom: 20px !important; }
      .loading-text { font-size: 18px !important; }
    }
    .loading-logo {
      width: 120px;
      height: 120px;
      margin-bottom: 30px;
      animation: pulse 2s ease-in-out infinite;
    }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loading-text {
      margin-top: 20px;
      color: white;
      font-size: 18px;
      font-weight: 500;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="appLoadingScreen">
    <div class="loading-logo">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="white">
        <circle cx="50" cy="50" r="40" stroke="white" stroke-width="3" fill="none"/>
        <path d="M50 20 L50 50 L70 50" stroke="white" stroke-width="3" fill="none"/>
      </svg>
    </div>
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading CalPro...</div>
  </div>

  <!-- Authentication Check Script -->
  <script>
    // Check authentication before loading the page
    (function() {
      const token = localStorage.getItem('auth_token');
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      
      // If no token or user, redirect to login
      if (!token || !user) {
        window.location.href = '/login.html';
        return;
      }
      
      // Store user info globally
      window.currentUser = user;
      window.authToken = token;
      
      // Demo mode detection
      const isDemoMode = window.location.hostname.includes('netlify') || 
                         window.location.hostname.includes('github.io') ||
                         window.location.hostname !== 'localhost';
      
      // Set default headers for all fetch requests
      window.fetchWithAuth = function(url, options = {}) {
        // Demo mode - return mock responses
        if (isDemoMode) {
          return Promise.resolve({
            ok: true,
            status: 200,
            json: () => Promise.resolve(getMockApiResponse(url)),
            text: () => Promise.resolve('Mock response')
          });
        }

        options.headers = {
          ...options.headers,
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        };
        return fetch(url, options)
          .then(response => {
            if (response.status === 401) {
              localStorage.removeItem('auth_token');
              localStorage.removeItem('user');
              window.location.href = '/login.html';
              throw new Error('Session expired');
            }
            return response;
          });
      };

      // Mock API responses for demo mode
      function getMockApiResponse(url) {
        if (url.includes('/api/user/profile')) {
          return { id: 1, email: user.email, name: user.name, role: user.role, department: user.department };
        }
        if (url.includes('/api/users')) {
          return { users: [
            { id: 1, name: 'Demo Admin', email: 'admin@demo.com', role: 'admin', status: 'active' },
            { id: 2, name: 'Demo User', email: 'user@demo.com', role: 'calibrator', status: 'active' }
          ], total: 2, page: 1, totalPages: 1 };
        }
        return { message: 'Demo mode - mock response', success: true };
      }
    })();
  </script>

  <!-- Dynamic Template Containers -->
  <div id="mobile-header-container"></div>
  <div id="sidebar-container"></div>
  
  <main class="main-content" id="mainContent">
    <!-- Demo Mode Banner -->
    <div id="demo-mode-banner" style="display: none; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; padding: 12px 20px; margin: 0; border-bottom: 1px solid #ffeeba; text-align: center; font-weight: 500;">
      <i class="fas fa-flask"></i> <strong>Demo Mode Active:</strong> This is a testing environment with simulated data and functionality
    </div>
    
    <div id="header-container"></div>
    <div id="content-container"></div>
  </main>
  
  <div id="modals-container"></div>

  <!-- Core Scripts -->
  <script src="js/core/router.js"></script>
  <script src="js/core/api-client.js"></script>
  <script src="js/core/state-manager.js"></script>
  <script src="js/core/template-loader.js"></script>
  
  <!-- Utility Modules -->
  <script src="js/utils/date-formatters.js"></script>
  <script src="js/utils/number-formatters.js"></script>
  <script src="js/utils/validators.js"></script>
  <script src="js/utils/dom-helpers.js"></script>
  <script src="js/utils/storage.js"></script>
  
  <!-- Feature Modules: Certificates -->
  <script src="js/features/certificates/pdf-generator.js"></script>
  <script src="js/features/certificates/form-handler.js"></script>
  
  <!-- Feature Modules: Worksheets -->
  <script src="js/features/worksheets/worksheet-manager.js"></script>
  
  <!-- Feature Modules: Dashboard -->
  <script src="js/features/dashboard/dashboard-manager.js"></script>
  
  <!-- Main Application Entry Point -->
  <script src="js/main.js"></script>
  
  <!-- Legacy app.js for backward compatibility -->
  <!-- <script src="app.js"></script> -->
  
  <!-- Application Initialization -->
  <script>
    // Main.js will handle initialization automatically
    // No manual initialization needed here
    
    // Hide loading screen after app initialization
    window.addEventListener('load', () => {
      setTimeout(() => {
        const loadingScreen = document.getElementById('appLoadingScreen');
        if (loadingScreen) {
          loadingScreen.classList.add('hidden');
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 300);
        }
      }, 500);
    });
  </script>
</body>
</html>
